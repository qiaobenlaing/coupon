<link th:replace="/include/header" />
<style>
#dictDfSearchForm p{
display: inline-block;
position: relative;
    right: 10px;
}
#dictDfSearchForm div {
    display: inline-block;
    position: relative;
    right:5px;
}
.datagrid-view input.datagrid-editable-input{
    padding: 0;
    margin: 0;
    /*由于height是行内样式所以需要通过js修改*/
    line-height: 40px;
    vertical-align: middle;
}
</style>
 <script th:src="@{/easyui/datagrid-scrollview.js}"></script> 
<script  th:inline="javascript">
var editDfRow = undefined;
var datagridDf=$("#dictDfGrid");
var editDtRow = undefined;
var datagridDt=$("#dictDtGrid");

//判断是否已有操作行，并给出操作提示
function operationInfo(editRow){
	if (editRow != undefined) {
        $.messager.alert('提示','请完成当前操作，可点击保存或取消！','info'); 
    }
}

//参数处理
function onBeforeLoad(param){
    $.each( $("#dictDfSearchForm").serializeArray(), function(index, item){
        param[item.name]=item.value;
    });
}

//按条件查询
function searchGrid(){
    var options = $('#dictDfGrid').datagrid('options');//返回属性对象，用于重新设定属性值
    var pager=$("#dictDfGrid").datagrid("getPager");//返回页面对象，用于设置分页代码
    options.pageNumber = 1;
    //这里需要修改分页插件中的当前页的值    
    pager.pagination("refresh",{
        pageNumber:1,
    });
    $('#dictDfGrid').datagrid('reload'); 
    editDfRow = undefined; 
    closeDtGrid();  
}

//清除查询条件
function clearSearch(){
    $('#dictDfSearchForm').form('clear');
}

//格式化数据字典列表中数据类型字段的内容
function formatType(id,row,index){
    return $g.form.formatType($g.comboData.DICT_DEFINE_TYPE, id);
}

//点击显示子项表格(如果点击的复选框不显示)
function dictDfGridOnSelect(index,field,value){
    if(field != 'dictDefineId'){
        var row = $('#dictDfGrid').datagrid('getRows')[index];
        $('#dictDtGrid').datagrid('load',[[@{/dictDetail/page?dictDefineId=}]]+row.dictDefineId);
        $('#dictDtGrid').datagrid('getPanel').panel('open');
    }
}

//开启编辑功能,dg为表格对象
function startEdit(editRow,dg){	
	dg.datagrid("beginEdit",editRow);//开启编辑      
	$(".datagrid-row-editing .textbox, .datagrid-row-editing .textbox-text").css({"height":"38px"});//设置编辑行样式").css({"height":"38px","margin-left":"1px","margin-top":"1px"});//设置编辑行样式	
	$("a.textbox-icon.combo-arrow").css({"height":"38px"},{"width":"30px"});

}

$(document).ready(function() {
    
	$(".editForm label").css("min-width","48px");//改变查询表单中的标签的宽度
	
	datagridDf=$("#dictDfGrid").datagrid({
		url:[[@{/dictDefine/page}]],  
        title: '系统参数管理',        
        fitColumns : true,//表格字段宽度自适应，但最好还是对每个字段宽度进行定义
        nowrap : false,//字段内容不换行
        border : false,//去掉组件的边框（当GRID在PANEL或者其他LAYOUT组件中显示时应该使用
        autoRowHeight:false,
        singleSelect: true,
        onBeforeLoad: onBeforeLoad,//用于提交查询条件
        pagination: true, //显示分页
        pageList : $g.page.DEFAULT_ROW_OPTIONS,//页大小下拉选项此项各value是pageSize的倍数
        pageSize: $g.page.DEFAULT_PAGE_SIZE,//页大小       
        fit: false, //datagrid自适应宽度   
        idField: 'dictDefineId', //主键       
        onClickCell: dictDfGridOnSelect,
        columns: [[//显示的列
            {field: 'dictDefineId', title: 'dictDefineId', width: 40, checkbox:true 
            },
            {field: 'dictDefineKey', title: '参数编码', width: 100, sortable: true,
            	editor: { type: 'textbox', options: { required: true,validType:'length[0,32]'} }
            },
            
            { field: 'dictDefineName', title: '参数名称',sortable:true, width: 100, 
                     editor: { type: 'textbox', options: { required: true,validType:'length[0,32]'} }
            },
            { field: 'dictDefineValue', title: '值域', width: 100,
                     editor: { type: 'textbox', options: { required: true,validType:'length[0,64]'} }
            },            
            { field: 'dictDefineType', title: '数据类型',sortable:true, width: 150,formatter:formatType,
            	editor: { type: 'combobox',options: {required: true,data:$g.comboData.DICT_DEFINE_TYPE,valueField: "value", textField: "text" } }
            },
            { field: 'remark', title: '备注', width: 200,
                editor: { type: 'textbox', options: { required: false,validType:'length[0,256]'} }
            }            
        ]],        
        toolbar: [
            { text: '添加', iconCls: 'icon-add', handler: function () {//添加列表的操作按钮添加，修改，删除等
            	
                operationInfo(editDfRow);//判断是否需要给出保存提示
                
                //添加时如果没有正在编辑的行，则在datagrid的第一行插入一行                          
                if (editDfRow == undefined) {
                	datagridDf.datagrid("insertRow", {
                        index: 0, // index start with 0
                        row: {
                        }
                    });
                    
                    //给当前编辑的行赋值,并设置样式
                    editDfRow = 0;
                    startEdit(editDfRow,datagridDf);
                }

            }}, '-',
            { text: '删除', iconCls: 'icon-remove', handler: function () {
                //删除时先获取选择行
                var rows =  $('#dictDfGrid').datagrid('getSelections');
              
                //选择要删除的行
                if (rows.length == 1) {
                     $.messager.confirm("提示", "你确定要删除吗?", function (r){  
                    	if(r){
                            var id=rows[0].dictDefineId;                                   
                    	    $g.post([[@{/dictDefine/remove?dictDefineId}]]+id,null,function(data){
                    	        $g.showMsg('消息', '删除成功！');
                    	        editDfRow = undefined;
                    	        datagridDf.datagrid("unselectAll");
                    	        datagridDf.datagrid('reload');   
                    	    }); 
                    	}
                    });
                } else {
                     $.messager.alert("提示", "请选择要删除的行", "info");
                }
            }}, '-',
            { text: '修改', iconCls: 'icon-edit', handler: function () {
                
                //修改时要获取选择到的行
                var rows = datagridDf.datagrid("getSelections");
                
                //如果只选择了一行则可以进行修改，否则不操作
                if (rows.length == 1) {
                    operationInfo(editDfRow);//判断是否需要给出保存提示
                    //当无编辑行时
                    if (editDfRow == undefined) {
                        //获取到当前选择行的下标
                        var index = datagridDf.datagrid("getRowIndex", rows[0]);
                        editDfRow = index;//把当前开启编辑的行赋值给全局变量editRow
                        startEdit(editDfRow,datagridDf);
                    }
                }else{
                	 $.messager.alert('提示','请选择一条进行修改！','info'); 
                }
            }}, '-',
            { text: '保存', iconCls: 'icon-save', handler: function () {
                 //保存时结束当前编辑的行，自动触发onAfterEdit事件如果要与后台交互可将数据通过Ajax提交后台
               datagridDf.datagrid("endEdit", editDfRow); 
            }}, '-',
            { text: '取消编辑', iconCls: 'icon-cancel', handler: function () {
                 //取消当前编辑行把当前编辑行改为undefined回滚改变的数据,取消选择的行
                 editDfRow = undefined;
                 datagridDf.datagrid("unselectAll");
                 datagridDf.datagrid('reload');
                 datagridDf.datagrid("rejectChanges");
                 
             }}, '-'],
        onAfterEdit: function (rowIndex, rowData, changes) {
                                
            //var updated = datagridDf.datagrid('getChanges', "updated");//获取更新
            //var inserted = datagridDf.datagrid('getChanges', "inserted");//获取添加
          
            /* if(updated.length==0 && inserted.length==0){
                $g.showMsg('消息', '没有修改！');
            }else{ */
                $g.post([[@{/dictDefine/save}]],rowData,function(data){
                    $g.showMsg('消息', '保存成功！');
                    datagridDf.datagrid('reload');
                    datagridDf.datagrid("rejectChanges");//对changes内容清空
                });
           // }
            
            datagridDf.datagrid("unselectAll");
            editDfRow = undefined; 
       }           
    });

	
	datagridDt=$("#dictDtGrid").datagrid({
            
        fitColumns : true,//表格字段宽度自适应，但最好还是对每个字段宽度进行定义
        nowrap : false,//字段内容不换行
        border : false,//去掉组件的边框（当GRID在PANEL或者其他LAYOUT组件中显示时应该使用
        autoRowHeight:false,
        singleSelect: false,
        onBeforeLoad:onBeforeLoad,//用于提交查询条件              
        fit: false, //datagrid自适应宽度   
        idField: 'dictDetailId', //主键
        columns: [[//显示的列
            {field: 'dictDetailId', title: 'dictDetailId', width: 40, checkbox:true 
            },
            {field: 'dictDetailKey', title: '参数子项编码', width: 100, sortable: true,
                editor: { type: 'textbox', options: { required: true,validType:'length[0,32]'} }
            },
            
            { field: 'dictDetailName', title: '参数子项名称',sortable:true, width: 100, 
                     editor: { type: 'textbox', options: { required: true,validType:'length[0,32]'} }
            },
            { field: 'dictDetailValue', title: '值域', width: 100,
                     editor: { type: 'textbox', options: { required: true,validType:'length[0,64]'} }
            },  
            { field: 'remark', title: '备注', width: 200,
                editor: { type: 'textbox', options: { required: false,validType:'length[0,256]'} }
            }
        ]],        
        toolbar: [
                    { text: '添加', iconCls: 'icon-add', handler: function () {//添加列表的操作按钮添加，修改，删除等
                        
                        operationInfo(editDtRow);//判断是否需要给出保存提示,1表示表格1
                        //添加时如果没有正在编辑的行，则在datagrid的第一行插入一行                          
                        if (editDtRow == undefined) {
                            datagridDt.datagrid("insertRow", {
                                index: 0, // index start with 0
                                row: {}
                            });
                            
                            //给当前编辑的行赋值,并设置样式
                            editDtRow = 0;
                            startEdit(editDtRow,datagridDt);
                        }

                    }}, '-',
                    { text: '删除', iconCls: 'icon-remove', handler: function () {
                        //删除时先获取选择行
                        var rows =  $('#dictDtGrid').datagrid('getSelections');
                      
                        //选择要删除的行
                        if (rows.length > 0) {
                             $.messager.confirm("提示", "你确定要删除吗?", function (r){  
                            	var ids = "";
                                if(r){
                                	for (var i = 0; i < rows.length; i++) {
                                        if(ids.length>0){
                                            ids += ",";
                                        }
                                       ids+=rows[i].dictDetailId;                                   
                                    }   
                                	 
                                     $g.post([[@{/dictDetail/remove?dictDetailIds=}]]+ids,null,function(data){
                                         $g.showMsg('消息', '删除成功！');
                                         editDtRow = undefined;
                                         datagridDt.datagrid("unselectAll");
                                         datagridDt.datagrid('reload');                                         
                                     });
                                }                                                               
                            });
                        } else {
                             $.messager.alert("提示", "请选择要删除的行", "info");
                        }
                    }}, '-',
                    { text: '修改', iconCls: 'icon-edit', handler: function () {
                        
                        //修改时要获取选择到的行
                        var rows = datagridDt.datagrid("getSelections");
                        
                        //如果只选择了一行则可以进行修改，否则不操作
                        if (rows.length == 1) {
                            operationInfo(editDtRow);//判断是否需要给出保存提示
                            //当无编辑行时
                            if (editDtRow == undefined) {
                                //获取到当前选择行的下标
                                var index = datagridDt.datagrid("getRowIndex", rows[0]);
                                editDtRow = index;//把当前开启编辑的行赋值给全局变量editRow
                                startEdit(editDtRow,datagridDt);
                            }
                        }else{
                            $.messager.alert('提示','只能选中一个进行修改！','info'); 
                        }
                    }}, '-',
                    { text: '保存', iconCls: 'icon-save', handler: function () {
                    	 datagridDt.datagrid("endEdit", editDtRow); 
                    }}, '-',
                    { text: '取消编辑', iconCls: 'icon-cancel', handler: function () {
                         //取消当前编辑行把当前编辑行改为undefined回滚改变的数据,取消选择的行
                         editDtRow = undefined;
                         datagridDt.datagrid("unselectAll");
                         datagridDt.datagrid('reload');
                         datagridDt.datagrid("rejectChanges");
                         
                     }}, '-'],
        onAfterEdit: function (rowIndex, rowData, changes) {
                                
           var updated = datagridDt.datagrid('getChanges', "updated");//获取更新
           var inserted = datagridDt.datagrid('getChanges', "inserted");//获取添加
           if(updated.length==0 && inserted.length==0){
               $g.showMsg('消息', '没有修改！');
           }else{
        	   var rowDf = $('#dictDfGrid').datagrid('getSelected');                   
               $g.post([[@{/dictDetail/save?dictDefineId=}]]+rowDf.dictDefineId,rowData,function(data){
                   $g.showMsg('消息', '保存成功！');  
                   datagridDt.datagrid('reload');
                   datagridDt.datagrid("rejectChanges");//对changes内容清空
               });
           }
           datagridDt.datagrid("unselectAll");
           editDtRow = undefined; 
        }      
    });
	
	 //页面打开时，默认不显示参数子项列表
	$('#dictDtGrid').datagrid('getPanel').panel('close', true);     
});
</script>
<div data-options="region:'west'" style="width:575px;border-top:0px;border-left:0px;border-bottom:0px;" class="layout-have-right-border">
	<div class="easyui-layout" data-options="fit:true,border:false" >
		<!-- 数据字典左列表查询框 -->
        <div data-options="region:'north',border:false,title:'查询条件'" style="height:90px;padding:10px 0px 10px 8px;">
			<form id="dictDfSearchForm" class="editForm" style="position: relative;">  
				 <p id="p1"><label style="padding-left: 10px;padding-right: 3px;">系统参数编码:</label>
				 <input type="text" class="easyui-textbox" name="dictDefineKey" style="width: 120px;height: 28px;"></p>
				 <p id="p2"><label style="padding-left: 10px;padding-right: 3px;">系统参数名称:</label>
				 <input type="text" class="easyui-textbox" name="dictDefineName" style="width: 120px;height: 28px;"></input></p> 
				 <div> 
				 <a href="javascript:void(0)"  data-options=" iconCls:'icon-search'" class="easyui-linkbutton"  onclick="searchGrid();">查询</a>
                 <a href="javascript:void(0)" data-options=" iconCls:'icon-reload'"  class="easyui-linkbutton"  onclick="clearSearch();">清空</a>
                 </div>  
			</form>
        </div>
        
        <!-- 数据字典左列表 -->
        <div data-options="region:'center',border:false" class="layout-have-top-border">
            <table id="dictDfGrid" class="easyui-datagrid"  style="height:100%"> </table>
        </div>
    </div>
</div>
<!-- 参数子项管理    右侧列表    DictDetail列表面板   -->
<div data-options="region:'center',title:'参数子项管理',border:false">
   	<table id="dictDtGrid" class="easyui-datagrid" data-options="border:false" style="height:100%;"></table>
</div>
<link th:replace="/include/footer" />
