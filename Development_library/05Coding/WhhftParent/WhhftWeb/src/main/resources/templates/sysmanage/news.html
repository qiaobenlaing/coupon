<link th:replace="/include/header" />
<script th:src="@{/ckeditor/ckeditor.js}"></script>
<script th:src="@{/js/Map.js}" ></script>
<style>

#searchForm p{
display: inline-block;
float:left;
position: relative;  
right: 35px;  
}

#searchForm div,#searchForm p{
    display: inline-block;
    vertical-align: middle;
}

h3{
    height: 40px;
    line-height: 40px;
    vertical-align:middle;
    font-size: 14px;
}

</style>
<script th:src="@{/easyui/datagrid-detailview.js}"></script>
<script th:inline="javascript">

var dg=$('#newsGrid');//获取表格
var ckeditor;
var jq=top.jQuery;

$(function () {     
    dg=$('#newsGrid').datagrid({
        url: [[@{/news/page}]], //请求的数据源
        method:"post",
        //iconCls: 'icon-save', //图标
        pagination: true, //显示分页
        pageList : $g.page.DEFAULT_ROW_OPTIONS,//页大小下拉选项此项各value是pageSize的倍数
        pageSize: $g.page.DEFAULT_PAGE_SIZE,//页大小              
        onBeforeLoad: onBeforeLoad, //用于提交查询条件       
        fit: false, //datagrid自适应宽度
        fitColumns: false, //列自适应宽度
        //striped: true, //行背景交换
        nowrap: true, //列内容多时自动折至第二行
        border: false,
        singleSelect:false,
        autoRowHeight:false,
        columns: [[//显示的列
            { field: 'newsId', title: '编号', width: 40, checkbox:true },
            { field: 'newsTitle', title: '新闻标题', width: 150,},
            { field: 'catalogName', title: '新闻栏目', width: 200},            
            { field: 'modifiedDate', title: '更新时间', width: 150 }, 
           // { field: 'content', title: '新闻内容', width: 430,hidden:'true'},
            { field: 'fileSeq', title: '文件夹编号', width: 230}
        ]],
        toolbar: [
                    { text: '添加', iconCls: 'icon-add', handler: function () {//添加列表的操作按钮添加，修改，删除等
                        add();                       
                    }}, '-',
                    { text: '编辑', iconCls: 'icon-edit', handler: function () {
                        edit();
                    }}, '-',
                    { text: '删除', iconCls: 'icon-remove', handler: function () {
                        del();
                    }}, '-',
                    { text: '刷新', iconCls: 'icon-reload', handler: function () {
                        searchGrid();
                    }}, '-'],        
           
        onDblClickRow: function (rowIndex, rowData) {
            
        }
    });
    
    //当重新选择页面时更新内容
    jq('#tt').tabs({        
          onSelect:function(title,index){  
              if(title=="新闻内容管理"){
                  $('#newsGrid').datagrid('reload'); 
              }              
          }
     });
    
    jq("#tt").tabs('select',"新闻内容管理");
});
   
//显示新闻编辑页面   
function show(type,newsId){   
	
	var src=[[@{/p/sysmanage/editNews.html?newsId=}]]+newsId +'&type='+type; 
	
    var content = '<iframe scrolling="auto" frameborder="0"  src='+src+' style="width:100%;height:100%;"></iframe>';
   
    if(type=="add"){
        addNewsEditTab("新建新闻",content,newsId) ;  //添加tab页  
    }else if(type=="update"){
    	//根据选中行得到新闻Id
        var rows = dg.datagrid("getSelections");
        var title=rows[0].newsTitle;
        
      /*   console.log("tabstabs", jq("#tt").tabs('tabs'));
        $.each(jq("#tt").tabs('tabs'), function(tab){
            console.log("update", tab, tab.id);
        }); */
        
        //判断如果该新闻id的tab页已经存在，则直接选中即可，若不存在则添加页面       
        if(!isExist(newsId)){//表示不存在，直接添加
            addNewsEditTab(title.substring(0,6),content,newsId) ;  //添加tab页  
        }else{
        	var index=top.tabMap.get(newsId);        	
            jq("#tt").tabs('select',index);//选择已打开的tab页,此处需要考虑标题重复的可能性，故不可以按标题
        }
    }
  
}


//判断需要显示的新闻id是否存在，
function isExist(newsId){
	if(top.tabMap.containsKey(newsId)){
		return true;
	}
    return false;
}

//添加新闻编辑选项页
function addNewsEditTab(title,content,newsId) {	 
	var newTab=jq('#tt').tabs('add',{
        title:title,
        content:content,
        closable:true
    }); 
}

//添加新闻
function add(){
	var newsId = generatorNewsId();//生成Id 
	//判断是否newsId生成成功
	if(newsId!=0){
		show('add',newsId);
	}else{
		 $g.showMsg('消息', '新闻id生成失败，添加失败！');
	}
}

//编辑新闻
function  edit(){
    //根据选择得到新闻信息
    var rows = dg.datagrid("getSelections");
    if(rows.length!=1){
        $.messager.alert('提示','请选择一条新闻进行编辑!','warning');
        return;
    }
    var newsId=rows[0].newsId; 
    show("update",newsId);   //打开编辑页面     
}

//用于添加时生成newsId,该请求注意必须同步,否则可能出现各种问题
function generatorNewsId(){       
    newsId = 0;    
    $.ajax({
        async : false, //同步,默认是true表示异步
        url : [[@{/news/generatorId}]],
        type : "post",
        dataType : "json",
        success : function(result) {
           newsId = result;
        }
    });
    return newsId;
}

//参数处理
function onBeforeLoad(param){
    $.each( $("#searchForm").serializeArray(), function(index, item){
        param[item.name]=item.value;
    });
}

//按条件查询
function searchGrid(){
    var options = dg.datagrid('options');//返回属性对象，用于重新设定属性值
    var pager=dg.datagrid("getPager");//返回页面对象，用于设置分页代码
    options.pageNumber = 1;
    //这里需要修改分页插件中的当前页的值    
    pager.pagination("refresh",{
        pageNumber:1,
    });
    dg.datagrid('reload'); 
    editRow = undefined; 
}
    
//清除查询条件
function clearSearch(){
   $('#searchForm').form('clear');
}

   
function del() {
//删除时先获取选择行
   var rows = dg.datagrid("getSelections");
   //选择要删除的行
   if (rows.length > 0) {
        $.messager.confirm("提示", "你确定要删除吗?", function (r){
            if (r) {
               var ids = "";
               for (var i = 0; i < rows.length; i++) {
                    if(ids.length>0){
                        ids += ",";
                    }
                   ids+=rows[i].newsId;                                   
               }                       
               $.post([[@{/news/remove?newsIds=}]]+ids,null,function(data){
                   $g.showMsg('消息', '删除成功！');
                   editRow = undefined;
                   dg.datagrid("unselectAll");
                   dg.datagrid('reload');                                        
               });
           }
       });
   } else {
        $.messager.alert("提示", "请选择要删除的行", "error");
   }
}
  
</script>




<div data-options="region:'north',border:false,title:'查询条件'"
    style="height: 90px; padding: 10px;">

    <form id="searchForm" class="editForm">
        <p id="p1">
            <label>新闻标题:</label> <input type="text" class="easyui-textbox"
                name="newsTitle" style="width: 300px; height: 30px;"></input>
        </p>
        &nbsp;&nbsp;
        <p id="p2">
            <label>新闻栏目:</label> <input type="text" class="easyui-textbox"
                name="catalogName" style="width: 250px; height: 30px;"></input>
        </p>
        <div><a href="javascript:void(0)" data-options=" iconCls:'icon-search'"
            class="easyui-linkbutton" onclick="searchGrid();">查询</a> <a
            href="javascript:void(0)" data-options=" iconCls:'icon-reload'"
            class="easyui-linkbutton" onclick="clearSearch();">清空</a></div>
    </form>
</div>
<!-- 表格 -->
<div data-options="region:'center',border:false"
    class="layout-have-top-border">
    <table id="newsGrid" class="easyui-datagrid"
        data-options=" border:false, title:'新闻内容管理'" style="height: 100%">
    </table>
</div>
 

<link th:replace="/include/footer" />



